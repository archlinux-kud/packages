# Maintainer: Albert I <kras@raphielgang.org>

pkgname=python-sushi-sub
pkgver=0.6.2
pkgrel=2
pkgdesc='Automatic subtitle shifter based on audio'
url='https://github.com/FichteFoll/Sushi'
arch=('any')
license=('MIT')
depends=('python-numpy' 'python-opencv')
makedepends=('python-build' 'python-installer' 'python-setuptools' 'python-wheel')
optdepends=('ffmpeg: for any kind of demuxing'
            'mkvtoolnix-cli: for fast timecodes extraction when demuxing'
            'scxvid: for making keyframes')
conflicts=('sushi-shifter-git')
replaces=('sushi-shifter-git')
source=("Sushi-${pkgver}.tar.gz::${url}/archive/refs/tags/${pkgver}.tar.gz"
        "Sushi-np-ma-average.patch::https://patch-diff.githubusercontent.com/raw/FichteFoll/Sushi/pull/1.patch")
sha384sums=('25183b7e5a9dcedc29bc6bcfd62e5acc4cfb262b1e2c9346549893093127a570db64c79f478ba658f6e0a501564b78ed'
            '29fdd4112d739ab75f595b00c32c8d6aa9df052e8d35125e910f2d79ebe969b87c188d9730d6386ca71c9dfa72d4aea2')
b2sums=('66827c0acd9acbce591a1a6934e709897dac385063b2c32cf49ad67dc9f59c949a64c2bcddec9de48ca01bdca51eadcaca27cdaf2359ac307044c7825e74f489'
        'd65e0391c0404da4ca1817152acea212860e0651ab4db86c4451a05219014d69c4bf6833af8450c919d7f5b3d2edabd0ea70102a7d9347db648aebfad9ff7079')

_python_version() {
    python3 <(\
        cat << 'EOF'
import sys
vi = sys.version_info
print(f"{vi.major}.{vi.minor}")
EOF
    )
}

prepare() {
    # Avoid an edge case of division-by-zero error
    patch -d "${srcdir}/Sushi-${pkgver}" -N -p1 <"${srcdir}/Sushi-np-ma-average.patch"
}

build() {
    cd "${srcdir}/Sushi-${pkgver}"
    python -m build -w -n
}

check() {
    cd "${srcdir}/Sushi-${pkgver}"
    # python -m unittest discover doesn't find anything
    python -m unittest tests.{timecodes,main,subtitles,demuxing}
}

package() {
    local _py=$(_python_version)

    cd "${srcdir}/Sushi-${pkgver}"
    python -m installer -d "${pkgdir}" dist/*.whl

    # Rename wrapper to avoid conflicts with sushi from [extra]
    mv "${pkgdir}"/usr/bin/sushi{,-sub}

    # Symlink LICENSE from wheel dist-info copy
    install -d "${pkgdir}/usr/share/licenses/${pkgname}"
    ln -s "../../../lib/python${_py}/site-packages/sushi_sub-${pkgver}.dist-info/LICENSE" \
        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
