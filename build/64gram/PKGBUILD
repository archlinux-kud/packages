# PKGBUILD is based on telegram-desktop by:
# - Sven-Hendrik Haase <svenstaro@archlinux.org>
# - hexchain <i@hexchain.org>

# Maintainer: Albert I <kras@raphielgang.org>

# Only bump if changelog explicitly says a TDesktop version
_tdesktop_ver=4.9.5
# We need to fetch our own cppgir copy here *shrugs*
_cppgir_commit=69ef481cba38e848554cc5403b8d4141d3c51335
_expected_lite_ver=0.6.3
# TDesktop currently depends on unstable glibmm
_glibmm_ver=2.77.0

pkgname=64gram
pkgver=1.0.92
_pkgver=${pkgver/.beta}
pkgrel=1
pkgdesc='Unofficial 64-bit Telegram Desktop build with some enhancements'
arch=('x86_64')
url="https://64gr.am"
license=('GPL3')
depends=('hunspell' 'ffmpeg' 'hicolor-icon-theme' 'lz4' 'minizip' 'openal' 'ttf-opensans'
         'qt6-imageformats' 'qt6-svg' 'qt6-wayland' 'xxhash' 'rnnoise'
         'pipewire' 'libxtst' 'libxrandr' 'jemalloc' 'abseil-cpp' 'libdispatch' 'openssl'
         'protobuf' 'glib2' 'libsigc++-3.0' 'xz')
makedepends=('cmake' 'git' 'ninja' 'python' 'range-v3' 'tl-expected' 'microsoft-gsl' 'meson'
             'extra-cmake-modules' 'wayland-protocols' 'plasma-wayland-protocols' 'libtg_owt'
             'gobject-introspection' 'boost' 'fmt' 'mm-common' 'perl-xml-parser')
optdepends=('webkit2gtk: embedded browser features'
            'xdg-desktop-portal: desktop integration')
provides=("telegram-desktop=${_tdesktop_ver}")
replaces=('tdesktop-x64' '64gram-desktop')
conflicts=('telegram-desktop' 'forkgram')
source=("https://github.com/TDesktop-x64/tdesktop/releases/download/v${_pkgver}/64Gram-${_pkgver}-full.tar.gz"
        "expected-lite-${_expected_lite_ver}.tar.gz::https://github.com/martinmoene/expected-lite/archive/refs/tags/v${expected_lite_ver}.tar.gz"
        "https://gitlab.com/mnauw/cppgir/-/archive/${_cppgir_commit}/cppgir-${_cppgir_commit}.tar.bz2"
        "https://download.gnome.org/sources/glibmm/${_glibmm_ver%.*}/glibmm-${_glibmm_ver}.tar.xz")
noextract=("expected-lite-${_expected_lite_ver}.tar.gz"
           "cppgir-${_cppgir_commit}.tar.bz2")
sha384sums=('8e44392eb84ea010ad09544cc7b1e45d951374796a59cd6d653c34d278dd9c6cd8e4a82486e38d68b52d203760237a3e'
            '6454e7b41a8319d7bef88352539ae11d6e050e4bef9379890fa53697fe83996b18d6f9681b0e079c64253f85a571d619'
            '04b272d85c9a9796c617053dc752f48f483f2441979e4d02e8f4d48a3f1b63e68f31000e9bbd972397137555a29de89d'
            '40fb55ba19444abffe65e56a0c6c729846db4f4388968bb8a020df0e691580fe36f541bad21a22d8b9a65fef50211bfd')
b2sums=('aa8df6b85c780ff3ab1c11b437918f0422f47e38daadc10871c0f856819d5640ee6f23e442124b9389f3ea115db7bc1e6ffb435240d9445ea3a392120f9ad221'
        '7b9eb948d674d4fb4904c6deb4f2c8c2d578d73d8401dc386a49c5f09cc75c6fd70e0c6aa72cd1e1fb9d82cf55917c8a6d60868190ba063340eda4f3191ebc56'
        'b34386e6beb76c68f4f52395fcca80583e56ef3fd4a327724bc19253e64fab3419b064d4e7371213e9e80c6ab233ad3d6290e07271c1dcdf90b5ae00d23bd481'
        'c9c48248e78b90101bb546474837f8f60bba4b8cd6b2b019e919964a9f0a2fb967cb9d2b61ca449587db01ddbeca8eb31147467cfe744ea071ba43a09badda72')

prepare() {
    # Replace bundled cppgir with external revision that works for us
    rm -rf "64Gram-${_pkgver}-full/cmake/external/glib/cppgir"
    mkdir -p "64Gram-${_pkgver}-full/cmake/external/glib/cppgir/expected-lite"
    tar xf "expected-lite-${_expected_lite_ver}.tar.gz" -C "64Gram-${_pkgver}-full/cmake/external/glib/cppgir/expected-lite" --strip-components 1
    tar xf "cppgir-${_cppgir_commit}.tar.bz2" -C "64Gram-${_pkgver}-full/cmake/external/glib/cppgir" --strip-components 1
}

build() {
    CXXFLAGS+=' -ffat-lto-objects'

    # Telegram currently needs unstable glibmm so we bundle it in as static libs.
    # This isn't great but what can you do.
    meson setup -D maintainer-mode=true --default-library static --prefix "${srcdir}/glibmm" glibmm-2.77.0 glibmm-build
    meson compile -C glibmm-build
    meson install -C glibmm-build

    # Turns out we're allowed to use the official API key that telegram uses for their snap builds:
    # https://github.com/telegramdesktop/tdesktop/blob/8fab9167beb2407c1153930ed03a4badd0c2b59f/snap/snapcraft.yaml#L87-L88
    # Thanks @primeos!
    PKG_CONFIG_PATH="${srcdir}/glibmm/usr/local/lib/pkgconfig" \
    cmake -B build -S "64Gram-${_pkgver}-full" -G Ninja \
        -DCMAKE_VERBOSE_MAKEFILE=ON \
        -DCMAKE_INSTALL_PREFIX="/usr" \
        -DCMAKE_PREFIX_PATH="${srcdir}/glibmm" \
        -DCMAKE_BUILD_TYPE=Release \
        -DTDESKTOP_API_ID=611335 \
        -DTDESKTOP_API_HASH=d524b414d21f4d37f08684c1df41ac9c

    cmake --build build
}

package() {
    DESTDIR="${pkgdir}" cmake --install build
}
