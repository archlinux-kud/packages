# PKGBUILD is based on telegram-desktop by:
# - Sven-Hendrik Haase <svenstaro@archlinux.org>
# - hexchain <i@hexchain.org>

# Maintainer: Albert I <kras@raphielgang.org>

# Only bump if changelog explicitly says a TDesktop version
_tdesktop_ver=4.9.3
# We need to fetch our own cppgir copy here *shrugs*
_cppgir_commit=fa346156b25dd79a8bf5a50cd10022858b859984
_expected_lite_ver=0.6.3
# TDesktop currently depends on unstable glibmm
_glibmm_ver=2.77.0

pkgname=64gram
pkgver=1.0.90
_pkgver=${pkgver/.beta}
pkgrel=1
pkgdesc='Unofficial 64-bit Telegram Desktop build with some enhancements'
arch=('x86_64')
url="https://64gr.am"
license=('GPL3')
depends=('hunspell' 'ffmpeg' 'hicolor-icon-theme' 'lz4' 'minizip' 'openal' 'ttf-opensans'
         'qt6-imageformats' 'qt6-svg' 'qt6-wayland' 'xxhash' 'rnnoise'
         'pipewire' 'libxtst' 'libxrandr' 'jemalloc' 'abseil-cpp' 'libdispatch' 'openssl'
         'protobuf' 'glib2' 'libsigc++-3.0' 'xz')
makedepends=('cmake' 'git' 'ninja' 'python' 'range-v3' 'tl-expected' 'microsoft-gsl' 'meson'
             'extra-cmake-modules' 'wayland-protocols' 'plasma-wayland-protocols' 'libtg_owt'
             'gobject-introspection' 'boost' 'fmt' 'mm-common' 'perl-xml-parser')
optdepends=('webkit2gtk: embedded browser features'
            'xdg-desktop-portal: desktop integration')
provides=("telegram-desktop=${_tdesktop_ver}")
replaces=('tdesktop-x64' '64gram-desktop')
conflicts=('telegram-desktop' 'forkgram')
source=("https://github.com/TDesktop-x64/tdesktop/releases/download/v${_pkgver}/64Gram-${_pkgver}-full.tar.gz"
        "expected-lite-${_expected_lite_ver}.tar.gz::https://github.com/martinmoene/expected-lite/archive/refs/tags/v${expected_lite_ver}.tar.gz"
        "https://gitlab.com/mnauw/cppgir/-/archive/${_cppgir_commit}/cppgir-${_cppgir_commit}.tar.bz2"
        "https://download.gnome.org/sources/glibmm/${_glibmm_ver%.*}/glibmm-${_glibmm_ver}.tar.xz")
noextract=("expected-lite-${_expected_lite_ver}.tar.gz"
           "cppgir-${_cppgir_commit}.tar.bz2")
sha384sums=('ec798ed8ebc6432f273f4ede659c2be5bac9f445635c17c921791e136b4fdbc2d35db8f11668e4225fabbb79e0415365'
            '6454e7b41a8319d7bef88352539ae11d6e050e4bef9379890fa53697fe83996b18d6f9681b0e079c64253f85a571d619'
            '86d322ef192dc195323e2d56821efc249f6e8cb912c7db9a8f12d4b82ec11e529e762aa38894b7164586d2121d2bc367'
            '40fb55ba19444abffe65e56a0c6c729846db4f4388968bb8a020df0e691580fe36f541bad21a22d8b9a65fef50211bfd')
b2sums=('c7a4fb2bcd3f9b735b25ae1b337ab1f3bd3df2053a843450c83382886b164405351467678be6a58966714fee54257887b3cdbb3a1d1cc4eabb870a7ab6e481cc'
        '7b9eb948d674d4fb4904c6deb4f2c8c2d578d73d8401dc386a49c5f09cc75c6fd70e0c6aa72cd1e1fb9d82cf55917c8a6d60868190ba063340eda4f3191ebc56'
        'aa4ae094e2337e8f845b10a14f6adf626efaa2e573baf53d34ee180e8be68b31e9bd967a24ce63e392a88c007b6f65221922754c10f154dbc5edbffdae786c61'
        'c9c48248e78b90101bb546474837f8f60bba4b8cd6b2b019e919964a9f0a2fb967cb9d2b61ca449587db01ddbeca8eb31147467cfe744ea071ba43a09badda72')

prepare() {
    # Replace bundled cppgir with external revision that works for us
    rm -rf "64Gram-${_pkgver}-full/cmake/external/glib/cppgir"
    mkdir -p "64Gram-${_pkgver}-full/cmake/external/glib/cppgir/expected-lite"
    tar xf "expected-lite-${_expected_lite_ver}.tar.gz" -C "64Gram-${_pkgver}-full/cmake/external/glib/cppgir/expected-lite" --strip-components 1
    tar xf "cppgir-${_cppgir_commit}.tar.bz2" -C "64Gram-${_pkgver}-full/cmake/external/glib/cppgir" --strip-components 1
}

build() {
    CXXFLAGS+=' -ffat-lto-objects'

    # Telegram currently needs unstable glibmm so we bundle it in as static libs.
    # This isn't great but what can you do.
    meson setup -D maintainer-mode=true --default-library static --prefix "${srcdir}/glibmm" glibmm-2.77.0 glibmm-build
    meson compile -C glibmm-build
    meson install -C glibmm-build

    # Turns out we're allowed to use the official API key that telegram uses for their snap builds:
    # https://github.com/telegramdesktop/tdesktop/blob/8fab9167beb2407c1153930ed03a4badd0c2b59f/snap/snapcraft.yaml#L87-L88
    # Thanks @primeos!
    PKG_CONFIG_PATH="${srcdir}/glibmm/usr/local/lib/pkgconfig" \
    cmake -B build -S "64Gram-${_pkgver}-full" -G Ninja \
        -DCMAKE_VERBOSE_MAKEFILE=ON \
        -DCMAKE_INSTALL_PREFIX="/usr" \
        -DCMAKE_PREFIX_PATH="${srcdir}/glibmm" \
        -DCMAKE_BUILD_TYPE=Release \
        -DTDESKTOP_API_ID=611335 \
        -DTDESKTOP_API_HASH=d524b414d21f4d37f08684c1df41ac9c

    cmake --build build
}

package() {
    DESTDIR="${pkgdir}" cmake --install build
}
